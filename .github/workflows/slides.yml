name: Build Majin Slides

on:
  workflow_dispatch: {}
  push:
    paths:
      - "**/*.md"
      - "slides/themes/**"
      - ".github/workflows/slides.yml"

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # Make secret available as env for conditional checks
      GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      FOLDER_ID: ""
      SHARE_EMAIL: ""
      TITLE: "Majin Slides"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install fonts (optional but recommended)
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-noto-color-emoji

      - name: Install deps (marp-cli + googleapis)
        run: |
          npm -v
          npm i -D @marp-team/marp-cli@latest
          npm i googleapis@latest

      - name: Render slides via Marp
        run: |
          set -euxo pipefail
          # Prefer the root file if present, otherwise fallback to sample
          PREF="改良版  まじん式プロンプト.md"
          ALT="改良版 まじん式プロンプト.md"
          if [ -f "$PREF" ]; then MD="$PREF"; elif [ -f "$ALT" ]; then MD="$ALT"; else MD="slides/sample.md"; fi
          T="Majin Slides"
          echo "Using MD_PATH=$MD\nUsing TITLE=$T"
          test -f "$MD" || (echo "Markdown not found: $MD"; git ls-files; exit 1)
          ls -la slides/themes || true
          mkdir -p dist
          npx marp --version
          # PDF / PPTX / HTML
          npx marp "$MD" --theme-set slides/themes/majin.css --allow-local-files --pdf --output dist/slides.pdf
          npx marp "$MD" --theme-set slides/themes/majin.css --allow-local-files --pptx --output dist/slides.pptx
          npx marp "$MD" --theme-set slides/themes/majin.css --allow-local-files --html --output dist/slides.html

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: majin-slides
          path: dist/

      - name: Upload PPTX to Google Slides (convert)
        id: upload
        if: ${{ env.GOOGLE_SERVICE_ACCOUNT_JSON != '' }}
        env:
          GDRIVE_FOLDER_ID: ${{ env.FOLDER_ID }}
          GDRIVE_SHARE_EMAIL: ${{ env.SHARE_EMAIL }}
        run: |
          T=${TITLE:-"Majin Slides"}
          node ./scripts/upload-to-gslides.mjs ./dist/slides.pptx "$T"

      - name: Summary
        run: |
          if [ -f .gslides-url ]; then
            echo "Slides URL: $(cat .gslides-url)" >> $GITHUB_STEP_SUMMARY
          else
            echo "Google Slides conversion skipped (no secret)." >> $GITHUB_STEP_SUMMARY
          fi
